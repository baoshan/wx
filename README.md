## WeiXin

(minimalist) WeChat Middleware for Express.js

## å¾®ä¿¡åº”ç”¨æ¡†æ¶

`wx`æ˜¯æç®€è®¾è®¡çš„å¾®ä¿¡ï¼ˆå…¬å…±å¹³å°ï¼‰åº”ç”¨å‚è€ƒçº§æ¡†æ¶ï¼Œè€Œå¹¶éå¾®ä¿¡æ¥å£åœ¨`node.js`ä¸‹çš„å¹‚ç­‰æ˜ å°„ã€‚


## å®‰è£…
`wx`è¦æ±‚åœ¨çº¿çš„**[Redis]**å®ä¾‹ã€‚é»˜è®¤æƒ…å†µä¸‹ï¼Œ`wx`å°è¯•è¿æ¥æœ¬åœ°å®ä¾‹ï¼Œæ‚¨å¯ä»¥æŒ‡å®š`Redis`è¿æ¥ã€‚åˆ©ç”¨`Redis`ï¼Œ`wx`å…·å¤‡ï¼š

+ é›†ç¾¤æ¨¡å¼ä¸‹è‡ªåŠ¨ç®¡ç†å¾®ä¿¡ä»¤ç‰Œï¼›
+ æµè§ˆå™¨ç«¯æ•æ‰äºŒç»´ç æ‰«æï¼›
+ ç­‰åŠŸèƒ½ã€‚

[Redis]:http://redis.io

===
1. ```npm install wx```

2. â˜ ç™»å½•**[å¾®ä¿¡å…¬ä¼—å¹³å°]**    
   â˜ é«˜çº§åŠŸèƒ½    
   â˜ å¼€å‘æ¨¡å¼ï¼Œè·å–ğŸ”‘
   
   [å¾®ä¿¡å…¬ä¼—å¹³å°]: https://mp.weixin.qq.com 
   
    *é…ç½®æœåŠ¡å™¨æ—¶ä»…tokenå¿…é¡»ã€‚  
      
3. æœåŠ¡å™¨ç«¯

  ```
   app = express()    
   wx  = new require 'wx'
     token      : 'xxx-xx-xx'
     app_id     : 'xx-xxx'
     app_secret : 'xxxxxxxxxxxx'
     redis_options :
       host     : 'redis.example.com'
       port     : '6379'
       options  : auth_pass: 'password'
   app.use '/wx', wx
   ```
4.  å¯åŠ¨åº”ç”¨ç¨‹åºåï¼Œä¿®æ”¹å¾®ä¿¡å¼€å‘æ¨¡å¼ä¸­æœåŠ¡å™¨é…ç½®ä¸ºï¼š`http://server.address/wx`ï¼Œä¸”æœ‰ä¸ç¨‹åºç›¸ä¸€è‡´çš„`token`ã€‚

## æ¥å—æ–‡æœ¬æ¶ˆæ¯

é€šè¿‡`wx.text`æ³¨å†Œæ–‡æœ¬æ¶ˆæ¯å¤„ç†æµç¨‹ï¼š  
 
   +  `req.content`ä¸ºç”¨æˆ·æ‰€å‘æ–‡æœ¬ï¼›  
   +  `req.user`åŒ…å«**[ç”¨æˆ·åŸºæœ¬ä¿¡æ¯]**  

[ç”¨æˆ·åŸºæœ¬ä¿¡æ¯]:http://mp.weixin.qq.com/wiki/index.php?title=è·å–ç”¨æˆ·åŸºæœ¬ä¿¡æ¯  

æ¢ç´¢å‡ ç§æ ¹æ®ç”¨æˆ·å‘é€æ–‡æœ¬ï¼Œé€šè¿‡`res.text`è¢«åŠ¨å›å¤çš„æ–¹å¼ï¼š  

**åŒ¹é…æ­£åˆ™è¡¨è¾¾å¼**    

```
wx.text /(.+)å¤©æ°”/, (req, res) ->
  res.text "#{req.params[1]}ï¼Œæ™´[å¤ªé˜³]"
```
**æ¥æ”¶æ–‡æœ¬å¸¸é‡**    

```
wx.text 'ä½ å¥½', (req, res) ->
  res.text "#{req.user.nickname}ï¼Œä¹ˆä¹ˆå“’"
```
**æ¥æ”¶ä»»æ„æ–‡æœ¬**    

```
wx.text (req, res) ->
  res.text "#{req.content}ï¼Œå–µå‘œ~"
```
*`wx`æŒ‰æ³¨å†Œé¡ºåºåŒ¹é…æ¶ˆæ¯ï¼Œæœ€åæ³¨å†Œæ¥æ”¶ä»»æ„æ–‡æœ¬å¥æŸ„ã€‚

## æ¥å—å…¶ä»–æ¶ˆæ¯

###  å›¾ç‰‡
ä¸‹é¢æ¼”ç¤ºäº†é€šè¿‡`wx.image`æ¥æ”¶ç”¨æˆ·å‘é€å›¾ç‰‡ï¼Œå†ä»¥`res.image`è¢«åŠ¨å›å¤ç›¸åŒå›¾ç‰‡çš„æ–¹å¼ï¼š

```
wx.img, (req, res) ->
  res.image req.media_id"
```
å¯ä»¥é€šè¿‡`wx.download`ä¸‹è½½å›¾ç‰‡ï¼Œå¾—åˆ°å›¾ç‰‡`buffer`:

```
wx.download req.media_id, (err, image) ->"
```
*`res.image`äº¦æ¥æ”¶å›¾ç‰‡æ–‡ä»¶è·¯å¾„ï¼Œè‡ªåŠ¨ä¸Šä¼ å›¾ç‰‡ï¼ˆä¸ºé¿å…è¯·æ±‚è¶…æ—¶ï¼Œå»ºè®®é¢„ä¼ å›¾ç‰‡ï¼Œæˆ–å…ˆ`ok`å†å‘é€å®¢æœå›¾ç‰‡æ¶ˆæ¯ï¼‰ã€‚

### è¯­éŸ³
ä¸‹é¢æ¼”ç¤ºäº†é€šè¿‡`wx.voice`æ¥æ”¶ç”¨æˆ·å‘é€å›¾ç‰‡ï¼Œå†ä»¥`res.voice`è¢«åŠ¨å›å¤ç›¸åŒè¯­éŸ³çš„æ–¹å¼ï¼š

```
wx.voice, (req, res) ->
  res.voice req.media_id"
```
å¯ä»¥é€šè¿‡`wx.download`ä¸‹è½½å›¾ç‰‡ï¼Œå¾—åˆ°è¯­éŸ³`buffer`:

```
wx.download req.media_id, (err, voice) ->"
```
*`res.voice`äº¦æ¥æ”¶è¯­éŸ³æ–‡ä»¶è·¯å¾„ï¼Œè‡ªåŠ¨ä¸Šä¼ è¯­éŸ³ï¼ˆä¸ºé¿å…è¯·æ±‚è¶…æ—¶ï¼Œå»ºè®®é¢„ä¼ è¯­éŸ³ï¼Œæˆ–å…ˆ`ok`å†å‘é€å®¢æœè¯­éŸ³æ¶ˆæ¯ï¼‰ã€‚

### è§†é¢‘
ä¸‹é¢æ¼”ç¤ºäº†é€šè¿‡`wx.video`æ¥æ”¶ç”¨æˆ·å‘é€å›¾ç‰‡ï¼Œå†ä»¥`res.video`è¢«åŠ¨å›å¤è§†é¢‘æ–‡ä»¶çš„æ–¹å¼ï¼š

```
wx.video, (req, res) ->
  res.video
    title        : 'è§†é¢‘æ ‡é¢˜'
    description  : 'è§†é¢‘æè¿°'
    video        : 'video.mp4'
```

### åœ°ç†ä½ç½®
ä¸‹é¢æ¼”ç¤ºäº†é€šè¿‡`wx.location`æ¥æ”¶ç”¨æˆ·å‘é€çš„åœ°ç†ä½ç½®ï¼Œå†é€šè¿‡`req.label`ã€`req.location_y`ã€`req.location_x`è·å–åœ°å€ã€ç»´åº¦ã€ç»åº¦çš„æ–¹å¼ï¼š

```
wx.location, (req, res) ->
  coordinate = req.location_x + ',' + req.location_y
  res.text "æ‚¨åœ¨#{req.label or coordinate}"
```

### é“¾æ¥
ä¸‹é¢æ¼”ç¤ºäº†é€šè¿‡`wx.link`æ¥æ”¶ç”¨æˆ·å‘é€é“¾æ¥ï¼Œå†é€šè¿‡`req.title`ã€`req.description`ã€`req.url`è·å–æ ‡é¢˜ã€æè¿°ä¸é“¾æ¥çš„æ–¹å¼ï¼š

```
wx.link, (req, res) ->
  res.text "ã€Š#{req.title}ã€‹ä¸€æ–‡å‘äººæ·±çœâ€¦"
```
##  å‘é€æ¶ˆæ¯

###  æ–‡æœ¬
**è¢«åŠ¨å›å¤æ–‡æœ¬æ¶ˆæ¯ï¼š**

```
wx.text 'æ–‡æœ¬', (req, res) ->
  res.text 'åŒ—äº¬ï¼Œæ™´[å¤ªé˜³]'
```
5ç§’å†…æ— æ³•åº”ç­”æ—¶ï¼Œå…ˆ`200`ï¼Œå†é€šè¿‡`req.user`å‘é€å®¢æœæ–‡æœ¬æ¶ˆæ¯ï¼ˆé¿å…å¾®ä¿¡æœåŠ¡å™¨å‘èµ·é‡è¯•ï¼‰ï¼š

```
wx.text 'æ–‡æœ¬', (req, res) ->
  res.ok()
    req.user.text 'åŒ—äº¬ï¼Œæ™´[å¤ªé˜³]'
```
**ä¸»åŠ¨å‘é€å®¢æœæ–‡æœ¬æ¶ˆæ¯ï¼š**

```
wx.user('xx_xxx').text('åŒ—äº¬ï¼Œæ™´[å¤ªé˜³]')
```

###  å›¾ç‰‡
**è¢«åŠ¨å›å¤å›¾ç‰‡æ¶ˆæ¯ï¼š**

ä½¿ç”¨`res.image`è¢«åŠ¨å›å¤å›¾ç‰‡ã€‚æ—¢å¯æŒ‡å®šæœ¬åœ°æ–‡ä»¶è·¯å¾„ï¼Œç”±`wx`è‡ªåŠ¨ä¸Šä¼ å›¾ç‰‡ï¼›äº¦å¯ç›´æ¥ä¼ å…¥æœ‰æ•ˆçš„`media_id`ï¼Œçœç•¥ä¸Šä¼ å›¾ç‰‡æ­¥éª¤ã€‚
```
wx.image, (req, res) ->
   res.image req.media_id
```
å¦‚éœ€ä¸Šä¼ å›¾ç‰‡ï¼Œå»ºè®®å…ˆ`200`ï¼Œå†é€šè¿‡`req.user`å‘é€å®¢æœæ¶ˆæ¯ï¼Œä»¥å…å› ä¸Šä¼ è€—æ—¶è¶…5ç§’å¯¼è‡´é‡è¯•ã€‚

```
wx.img, (req, res) ->
  res.ok()
    req.user.image 'image.jpg'
```
ä¸Šä¼ å›¾ç‰‡è·å–`media_id`æ–¹å¼ä¸ºï¼š

```
wx.upload 'image', 'image.jpg', (req, res) ->
  # res.media_id æ˜¯ä¸Šä¼ å›¾ç‰‡çš„ media_id
```
**ä¸»åŠ¨å‘é€å®¢æœå›¾ç‰‡æ¶ˆæ¯ï¼š**

```
wx.user('xx_xxx').image('image.jpg')
```

###  è¯­éŸ³
**è¢«åŠ¨å›å¤è¯­éŸ³æ¶ˆæ¯ï¼š**

ä½¿ç”¨`res.voice`è¢«åŠ¨å›å¤è¯­éŸ³ã€‚æ—¢å¯æŒ‡å®šæœ¬åœ°æ–‡ä»¶è·¯å¾„ï¼Œç”±`wx`è‡ªåŠ¨ä¸Šä¼ è¯­éŸ³ï¼›äº¦å¯ç›´æ¥ä¼ å…¥æœ‰æ•ˆçš„`media_id`ï¼Œçœç•¥ä¸Šä¼ è¯­éŸ³æ­¥éª¤ã€‚
```
wx.voice, (req, res) ->
   res.voice req.media_id
```
å¦‚éœ€ä¸Šä¼ è¯­éŸ³ï¼Œå»ºè®®å…ˆ`200`ï¼Œå†é€šè¿‡`req.user`å‘é€å®¢æœæ¶ˆæ¯ï¼Œä»¥å…å› ä¸Šä¼ è€—æ—¶è¶…5ç§’å¯¼è‡´é‡è¯•ã€‚

```
wx.voice, (req, res) ->
  res.ok()
    req.user.image 'voice.amr'
```
ä¸Šä¼ å›¾ç‰‡è·å–`media_id`æ–¹å¼ä¸ºï¼š

```
wx.upload 'voice', 'voice.amr', (req, res) ->
  # res.media_id æ˜¯å¯ä»¥é‡ç”¨çš„è¯­éŸ³ media_id
```
**ä¸»åŠ¨å‘é€å®¢æœè¯­éŸ³æ¶ˆæ¯ï¼š**

```
wx.user('xx_xxx').voice('image.jpg')
```

###  è§†é¢‘
**è¢«åŠ¨å‘é€è§†é¢‘æ¶ˆæ¯ï¼š**

ä½¿ç”¨`res.video`è¢«åŠ¨å›å¤è§†é¢‘ã€‚æ—¢å¯æŒ‡å®šæœ¬åœ°æ–‡ä»¶è·¯å¾„ï¼Œç”±`wx`è‡ªåŠ¨ä¸Šä¼ è¯­éŸ³ï¼›äº¦å¯ç›´æ¥ä¼ å…¥æœ‰æ•ˆçš„`media_id`ï¼Œçœç•¥ä¸Šä¼ è§†é¢‘æ­¥éª¤ã€‚
```
wx.video, (req, res) ->
  res.video
    title        : 'è§†é¢‘æ ‡é¢˜'
    description  : 'è§†é¢‘æè¿°'
    video        : 'video.mp4'
```
å¦‚éœ€ä¸Šä¼ è§†é¢‘ï¼Œå»ºè®®å…ˆ`200`ï¼Œå†é€šè¿‡`req.user`å‘é€å®¢æœæ¶ˆæ¯ï¼Œä»¥å…å› ä¸Šä¼ è€—æ—¶è¶…5ç§’å¯¼è‡´é‡è¯•ã€‚

```
wx.video, (req, res) ->
  res.ok()
    req.user.video ...
```
ä¸Šä¼ è§†é¢‘è·å–`media_id`æ–¹å¼ä¸ºï¼š

```
wx.upload 'video', 'video.mp4', (req, res) ->
  # res.media_id æ˜¯å¯ä»¥é‡ç”¨çš„è§†é¢‘ media_id
```
**ä¸»åŠ¨å‘é€è§†é¢‘æ¶ˆæ¯ï¼š**

```
wx.user('xx_xxx').video ...
```

###  éŸ³ä¹
**è¢«åŠ¨å‘é€éŸ³ä¹æ¶ˆæ¯ï¼š**

éœ€ä¸Šä¼ ä¸“è¾‘å›¾ç‰‡æ—¶ï¼Œå…ˆ`200`ï¼Œå†é€šè¿‡`req.user.music`å‘é€å®¢æœéŸ³ä¹æ¶ˆæ¯ï¼ˆé¿å…ä¸Šä¼ è€—æ—¶è¶…5ç§’ï¼Œå¾®ä¿¡æœåŠ¡å™¨å‘èµ·é‡è¯•ï¼‰ï¼š
```
wx.text 'éŸ³ä¹', (req, res) ->
  music =
    title        : 'éŸ³ä¹æ ‡é¢˜'
    description  : 'éŸ³ä¹æè¿°'
    music_url    : 'http://182.92.129.185/music.mp3'
    hq_music_url : 'http://182.92.129.185/music.mp3'
    thumb_media  : 'cover.jpg'
  res.music music
```
æ— å®¢æœæ¶ˆæ¯æƒé™ï¼Œæˆ–å·²çŸ¥ä¸“è¾‘å°é¢`thumb_media_id`æ—¶ï¼Œå¯ç›´æ¥å›å¤éŸ³ä¹ï¼š

```
wx.text 'éŸ³ä¹', (req, res) ->
  res.music music
```
ä¸Šä¼ ç¼©ç•¥å›¾è·å–`media_id`æ–¹å¼ä¸ºï¼š

```
wx.upload 'thumb', 'cover.jpg', (req, res) ->
  # res.thumb_media_id æ˜¯å¯ä»¥é‡ç”¨çš„ç¼©ç•¥å›¾ thumb_media_id

```
**ä¸»åŠ¨å‘é€è§†é¢‘æ¶ˆæ¯ï¼š** ä¸¾ä¸€åä¸‰ğŸ˜„

###  å›¾æ–‡
**è¢«åŠ¨å‘é€å›¾æ–‡æ¶ˆæ¯ï¼š**

```
wx.text 'å›¾æ–‡', (req, res) ->
  news = [
    title       : 'å¤´æ¡æ–°é—»æ ‡é¢˜'
    description : 'å¤´æ¡æ–°é—»æè¿°'
    pic_url     : ''
    url         : ''
  ,
    title       : 'æ¬¡æ¡æ–°é—»æ ‡é¢˜'
    description : 'æ¬¡æ¡æ–°é—»æè¿°'
    pic_url     : ''
    url         : ''
  ]
  res.news news
```
äº¦å¯é€šè¿‡req.userå‘é€å®¢æœæ–°é—»æ¶ˆæ¯

```
wx.text 'æ–°é—»', (req, res) ->
  res.ok()
  req.user.news news
```
**ä¸»åŠ¨å‘é€å›¾æ–‡æ¶ˆæ¯ï¼š** ä¸¾ä¸€åä¸‰ğŸ˜„

###  æ–‡æœ¬
**æ¶ˆæ¯è½¬å¤šå®¢æœï¼š**

é€šè¿‡`res.transfer`æ–¹æ³•ï¼Œå°†æ¶ˆæ¯è½¬å‘åˆ°å¤šå®¢æœ
```
wx.text /å®¢æœ.*/, (req, res) ->
  res.transfer()
```
*[å…¬å…±å¹³å°å¼€å‘è€…æ–‡æ¡£]æœ‰æ›´å¤šå…³äºå¤šå®¢æœçš„å¼€å‘è€…èµ„æ–™ã€‚åœ¨[å¤šå®¢æœ]ç½‘ç«™ä¸‹è½½å®¢æˆ·ç«¯ã€‚

[å…¬å…±å¹³å°å¼€å‘è€…æ–‡æ¡£]:http://mp.weixin.qq.com
[å¤šå®¢æœ]:http://dkf.qq.com

##  ç‚¹å‡»æŒ‰é’®

å“åº”æŒ‰é’®ç‚¹å‡»ï¼Œæˆ‘ä»¬åŠªåŠ›è¿«è¿‘æœ€ä¸ºè‡ªç„¶çš„æ–¹å¼ï¼š   
ä½¿ç”¨`wx.click`æ–¹æ³•ï¼ŒæŒ‡å®šè¢«ç‚¹å‡»æŒ‰é’®åç§°ï¼Œå³å¯æ•æ‰è¯¥æŒ‰é’®ç‚¹å‡»äº‹ä»¶ã€‚

```
wx.click 'ç‚¹å‡»æŒ‰é’®', (req, res) ->
   res.text "è¢«#{req.user.nickname}ç‚¹äº†ä¸€ä¸‹[å®³ç¾]"
```

##  ç¼–è¾‘æŒ‰é’®

ç¼–è¾‘èœå•æ˜¯ä¸€ç§å†…å®¹åˆ›æ„ï¼Œåº”å½“ç”±m`arkdown`æ¥å®Œæˆã€‚ä½¿ç”¨`wx`ï¼Œä½ å¯ä»¥ç«‹å³é¢„è§ˆèœå•æ•ˆæœï¼Œæ— éœ€å…³æ³¨æ›´å¤šã€‚å®‰è£…`wx`åï¼Œå¯ä»¥é€šè¿‡`http://server.address/wx/admin`åœ°å€è¿›å…¥ç®¡ç†ç•Œé¢

```
[
  {
    "type": "click",
    "name": "ç‚¹å‡»æŒ‰é’®",
    "key": "ç‚¹å‡»æŒ‰é’®"
  },
  {
    "type": "view",
    "name": "é“¾æ¥æ–‡æ¡£",
    "url": "http://mp.weixin.qq.com/wiki"
  },
  {
    "type": "click",
    "name": "äºŒçº§èœå•",
    "key": "äºŒçº§èœå•",
    "sub_button": [
      {
        "type": "view",
        "name": "é“¾æ¥è·³è½¬",
        "url": "http://github.com/baoshan/wx"
      },
      {
        "type": "click",
        "name": "æ‹‰å–ä¿¡æ¯",
        "key": "æ‹‰å–ä¿¡æ¯"
      }
    ]
  }
]
```

##  æ‰«æäºŒç»´ç ç™»å½•
**æœåŠ¡å™¨ç«¯**

é€šè¿‡`wx.scan`æ³¨å†Œæ‰«ç å¤„ç†æµç¨‹ã€‚å“åº”å¥æŸ„å‚æ•°åˆ†åˆ«ä¸ºï¼š

1.  æµè§ˆå™¨è¯·æ±‚ï¼ŒåŒ…å«`req.session`ä¼šè¯ã€`req.user`å¾®ä¿¡ç”¨æˆ·ã€`req.query`äºŒç»´ç å‚æ•°ï¼›
2.  å¾®ä¿¡å“åº”ï¼Œå¯è¢«åŠ¨å›å¤å„ç§æ¶ˆæ¯ï¼›
3.  æµè§ˆå™¨å›è°ƒæ–¹æ³•ï¼Œå¯å‘æµè§ˆå™¨å‘é€ä»»æ„æ•°æ®ã€‚

```
wx.scan (req, res, desktop_callback) ->
  req.session.user = req.user
  res.text "#{req.user.nickname}ä»#{req.query.from}ç™»å½•"
  desktop_callback req.user
```
**æ ‡è®°è¯­è¨€***

```
    <script src="/wx/wx.js"></script>     
    <img id="ç™»å½•äºŒç»´ç " src="/wx/qrcode?from=ç½‘é¡µ" />
```
**æµè§ˆå™¨ç«¯**

```
$('#ç™»å½•äºŒç»´ç ').scan (user) -> 
  {headimgurl: src, nickname: title} = user
  $img = $ "<img src='#{src}' /><p>#{title}</p>"
  $(@).replaceWith($img)
```
*å»ºè®®ä¸ºæ‰€æœ‰äºŒç»´ç æŒ‡å®šåç§°è¿›è¡Œåˆ†ç±»ï¼Œè§ä¸´æ—¶äºŒç»´ç ä¸æ°¸ä¹…äºŒç»´ç éƒ¨åˆ†ã€‚

##  ä¸´æ—¶äºŒç»´ç 
æŒ‡å®šåç§°ï¼Œå¯ä¸ºäºŒç»´ç åˆ†ç±»ã€‚ä¸‹é¢äºŒç»´ç åç§°ä¸º`fruits`ï¼š

```
    <script src="/wx/wx.js"></script>     
    <img src="/wx/qrcode/fruits?name=ğŸ’" />
```
*`wx`è‡ªåŠ¨ä¸ºè¢«æ‰«æçš„äºŒç»´ç å¢åŠ `scanned`ç±»åã€‚

æœåŠ¡å™¨ç«¯åœ¨`wx.scan`ä¸­æŒ‡å®šäºŒç»´ç åç§°ï¼Œæ³¨å†Œè¯¥ç±»äºŒç»´ç çš„å¤„ç†æµç¨‹ã€‚

```
wx.scan 'fruits', (req, res, desktop_callback) ->
  res.text "#{req.user.nickname}å·åƒäº†#{req.query.name}"
  desktop_callback 'åƒä¸€å£'
```
##  æ°¸ä¹…äºŒç»´ç 
*æ°¸ä¹…äºŒç»´ç å›¾æ¡ˆç¨³å®šï¼Œæ°¸ä¸è¿‡æœŸï¼Œé€‚äºå°åˆ·å“ã€å¹¿å‘Šç­‰ï¼Œå®ç°æ¥æºç»Ÿè®¡ç”¨é€”ã€‚
åç§°åœ¨`1`ï¼`100000`é—´ä¸ºæ°¸ä¹…äºŒç»´ç ï¼Œ`[continuous]`æ¡ç æ”¯æŒè¿ç»­æ‰«æï¼š

**æœåŠ¡å™¨ç«¯**

é€šè¿‡`permanent`åç§°æ³¨å†Œæ°¸ä¹…äºŒç»´ç æ‰«ç å¤„ç†æµç¨‹ï¼Œç”¨`req.params.scene_id`è·å–ç¼–å·ã€‚

```
wx.scan 'permanent', (req, res, callback) ->
  {nickname} = req.user
  {from} = req.query
  {scene_id} = req.params
  res.text "#{nickname}æ‰«æ#{from}ç¼–å·#{scene_id}çš„æ°¸ä¹…äºŒç»´ç "
  callback req.user
```
**æµè§ˆå™¨ç«¯**

é€šè¿‡`scan`æ–¹æ³•ï¼Œæ•æ‰æ°¸ä¹…äºŒç»´ç æ‰«æäº‹ä»¶
```
$('#æ°¸ä¹…äºŒç»´ç ').scan ({nickname: title, headimgurl: src}) ->
  $img = $("<img src='#{src}' title='#{title}' />")
  $('#div_headimgs').append($img)
  $img.load -> $(@).addClass('loaded')
```

##  å…³æ³¨ä¸å–æ¶ˆå…³æ³¨
**å…³æ³¨**

é€šè¿‡`wx.subscribe`æ³¨å†Œå…³æ³¨äº‹ä»¶ã€‚

```
wx.subscribe (req, res) ->
  nickname = req.user.nickname
  res.text "[ç¤¼ç‰©]æ¬¢è¿#{nickname}å…³æ³¨å¾®ä¿¡åº”ç”¨æ¡†æ¶ï¼"
```
*å½“ç”¨æˆ·é€šè¿‡æ‰«æäºŒç»´ç å…³æ³¨æ—¶ï¼Œå¦‚å·²æ³¨å†Œç›¸åº”çš„äºŒç»´ç æ‰«ç å¤„ç†æµç¨‹ï¼Œåˆ™äº¤ç»™è¯¥æµç¨‹å¤„ç†ï¼Œä¸è§¦å‘`subscribe`äº‹ä»¶ï¼Œä»å¯æ ¹æ®`scan`äº‹ä»¶çš„`req.event`ä¸º`subscribe`åˆ¤æ–­ç”¨æˆ·ä¸ºé€šè¿‡æ‰«ç å…³æ³¨ã€‚

**å–æ¶ˆå…³æ³¨**

é€šè¿‡`wx.unsubscribe`æ³¨å†Œå–æ¶ˆå…³æ³¨äº‹ä»¶ã€‚

```
wx.unsubscribe (req, res) ->
  # æŒ‰å…·ä½“éœ€æ±‚è¿›è¡Œå¤„ç†ã€‚
  res.ok()
```

##  è·å–å…³æ³¨è€…åˆ—è¡¨
é€šè¿‡`wx.subscribers`æ–¹æ³•ï¼Œæ‹‰å–å…³æ³¨è€…åˆ—è¡¨ï¼š

```
wx.subscribers (err, res) ->
  console.log res if res
```
è·å–åˆ°çš„å…³æ³¨è€…åˆ—è¡¨ç»“æ„ï¼š

```
{
  "total" : 23000,
  "count" : 10000,
  "data"  : {"openid": ["OPENID1", ...]},
  "next_openid": "NEXT_OPENID"
}
```
äº¦å¯æŒ‡å®š`next_openid`ï¼Œæ‹‰å–åç»­ç”¨æˆ·åˆ—è¡¨ï¼š

```
wx.subscribers next_openid, (err, res) ->
```
###  æ›´å¤šæ—¶å€™â€¦â€¦

å¯ä»¥è€ƒè™‘ç”¨`wx.populate_subscribers`è·å–æŒ‡å®šèŒƒå›´å†…å…³æ³¨è€…å®Œæ•´ä¿¡æ¯ï¼ˆåˆ†é¡µæ˜¾ç¤ºå…³æ³¨ç”¨æˆ·ã€æ‰¹é‡å‘é€å®¢æœæ¶ˆæ¯ç­‰ï¼‰ã€‚

```
wx.populate_subscribers from, to, (err, res) ->
  {total, subscribers} = res if res
```
è·å–åˆ°çš„æŒ‡å®šèŒƒå›´å…³æ³¨è€…å®Œæ•´ä¿¡æ¯ç»“æ„ï¼š

```
{
  total       : 23000,
  subscribers : [{
    "subscribe"      : 1,
    "openid"         : "......",
    "nickname"       : "Band",
    "sex"            : 1,
    "language"       : "zh_CN",
    "city"           : "å¹¿å·",
    "province"       : "å¹¿ä¸œ",
    "country"        : "ä¸­å›½",
    "headimgurl"     : "http://wx.qlogo.cn/...",
    "subscribe_time" : 1382694957
  }, ...]
}
```

## æœ‰é™çŠ¶æ€æœº

å®šä¹‰ç”¨æˆ·æ‰€å¤„çŠ¶æ€ä¸å„çŠ¶æ€é—´è·ƒè¿æ¡ä»¶ï¼Œå¾®ä¿¡åº”ç”¨æ¡†æ¶å¸®åŠ©æ‚¨åˆ†è§£å¤æ‚ä¸šåŠ¡ï¼Œä¸”æ¯«ä¸å¦¥åç ”å‘ä½“éªŒï¼š

```
wx.click 'ç”³åŠ', (req, res) ->
  res.text 'å›å¤â€œå›ºè¯â€ç”³åŠå›ºè¯ï¼Œå›å¤â€œå®½å¸¦â€ç”³åŠå®½å¸¦ã€‚'
  req.user.state 'ç”³åŠ'
  
wx.state('ç”³åŠ').text 'å›ºè¯', (req, res) ->
  req.text 'æ­£åœ¨ä¸ºæ‚¨ç”³åŠå›ºè¯ä¸šåŠ¡ï¼Œè¯·æä¾›è®¤è¯ç…§ç‰‡ã€‚'
  req.user.state 'è®¤è¯'
  
wx.state('è®¤è¯').image (req, res) ->
  req.text 'å·²æ”¶åˆ°æ‚¨æäº¤çš„è®¤è¯å›¾ç‰‡ï¼Œè¯·å‘é€è£…æœºåœ°å€ã€‚'
  req.user.state 'è£…æœº'
  
wx.state('è£…æœº').location (req, res) ->
  res.text "å·¥ç¨‹å¸ˆæ­£å‰å¾€#{req.label}ä¸ºæ‚¨å®‰è£…å›ºè¯ã€‚"
  req.user.state null
```
*è¿™ä¸ªåˆ›æ„å°šæœªå®ç°ğŸ˜¿ï¼ŒBut, [let's have a hackathon]ğŸ™‹ï¼Œæ›´[æ¬¢è¿è®¾è®¡å¸ˆâ›„ï¸åŠ å…¥]ã€‚æˆ‘ä»¬æä¾›æœ‰ç«äº‰åŠ›çš„è–ªèµ„ã€ç¦åˆ©ä¸å·¥ä½œç¯å¢ƒã€‚

[let's have a hackathon]:mailto:kuaiyusheng@wedocare.com?subject=Let&#039;s have a hackathonï¼Œæ¥è‡ªå¾®ä¿¡åº”ç”¨æ¡†æ¶&body=Hey ya! æˆ‘ä»¬ä¸€èµ·è®¾è®¡ç°ä»£çš„äº’è”ç½‘åº”ç”¨ï¼%0D%0A%0D%0Aé™„ä»¶ä¸­æ˜¯æˆ‘çš„ç®€å†ï¼Œæˆ‘çš„GitHubè´¦å·æ˜¯ï¼š

[æ¬¢è¿è®¾è®¡å¸ˆâ›„ï¸åŠ å…¥]:mailto:kuaiyusheng@wedocare.com?subject=Let&#039;s have a hackathonï¼Œæ¥è‡ªå¾®ä¿¡åº”ç”¨æ¡†æ¶&body=Hey ya! æˆ‘ä»¬ä¸€èµ·è®¾è®¡ç°ä»£çš„äº’è”ç½‘åº”ç”¨ï¼%0D%0A%0D%0Aé™„ä»¶ä¸­æ˜¯æˆ‘çš„ç®€å†ï¼Œæˆ‘çš„Dribbbleæˆ–Behanceè´¦å·æ˜¯ï¼š